<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="leave_of">
    <select id="vac_search" resultType="vo.Leave_ofVO" parameterType="map">
        <!--        select * from attendance a inner join emp e on a.empno = e.empno -->

        select lname,ldate,duration,lprocessed,lstatus
        from leave_of
        where empno = #{empno} and date_format(ldate, '%Y') = 2025

    </select>

    <select id="yearsSearch" parameterType="map" resultType="vo.Leave_ofVO">
        select lname,ldate,duration,lprocessed,lstatus
        from leave_of
        where empno = #{empno} and date_format(ldate, '%Y') = #{year}
    </select>

    <select id="approvevac" resultType="vo.Leave_ofVO" parameterType="String">
        select * from leave_of l inner join emp e on l.empno = e.empno
        inner join dept d on e.deptno = d.deptno
        inner join leave_history lh on e.empno = lh.empno

        where e.deptno = #{mgrsdeptno} and lstatus = 0
        and year = date_format(ldate, '%Y')
    </select>

    <select id="searchvac" resultType="vo.Leave_ofVO" parameterType="String">
        select * from leave_of l inner join emp e on l.empno = e.empno
        inner join dept d on e.deptno = d.deptno
        inner join leave_history lh on e.empno = lh.empno

        where e.deptno = #{mgrsdeptno} and lstatus in (1, 2)
        and year = date_format(ldate, '%Y')
    </select>

    <select id="getLnum" resultType="String" parameterType="String">
        select l.lnum from leave_of l inner join emp e
        on l.empno = e.empno
        where l.empno = #{empno}
        ORDER BY l.ldate DESC
        LIMIT 1
    </select>

    <select id="getOne" resultType="vo.Leave_ofVO" parameterType="String">
        select l.lstatus, e.empno from leave_of l inner join emp e
        on l.empno = e.empno
        where l.lnum = #{lnum}
    </select>

    <select id="getLname" resultType="vo.Leave_ofVO" parameterType="String">
        select l.
    </select>

    <update id="statusUpdate" parameterType="String">
        UPDATE leave_of
        SET lstatus = 1
        WHERE lnum = #{lnum}
    </update>

    <update id="remainLeaveUpdate" parameterType="Map">
        UPDATE leave_history
        SET remain_leave = remain_leave - #{duration}
        WHERE empno = #{empno}
    </update>

    <insert id="insertAttLeave" parameterType="map">
        INSERT INTO attendance (empno, date, chkin, chkout, attend_status, attend_note)
        VALUES
        <foreach collection="dates" item="date" separator=",">
            (
            #{empno},
            #{date},
            '00:00:00',
            '00:00:00',
            2,
            #{lname}
            )
        </foreach>
    </insert>

    <insert id="insertAttLeave3" parameterType="map">
        INSERT INTO attendance (empno, date, chkin, chkout, attend_status, attend_note)
        VALUES
        <foreach collection="dates" item="date" separator=",">
            (
            #{empno},
            #{date},
            '13:00:00',
            '18:30:00',
            3,
            #{lname}
            )
        </foreach>
    </insert>

    <insert id="insertAttLeave4" parameterType="map">
        INSERT INTO attendance (empno, date, chkin, chkout, attend_status, attend_note)
        VALUES
        <foreach collection="dates" item="date" separator=",">
            (
            #{empno},
            #{date},
            '08:55:00',
            '13:00:00',
            4,
            #{lname}
            )
        </foreach>
    </insert>
</mapper>